# Maintainer: GhostKellz <ghostkellz@ghostkellz.sh>
pkgname=ghostwave
pkgver=0.1.0
pkgrel=1
pkgdesc="NVIDIA RTX Voice-style AI noise suppression for Linux"
arch=('x86_64')
url="https://github.com/ghostkellz/ghostwave"
license=('MIT')
depends=(
    'pipewire'
    'pipewire-pulse'
    'wireplumber'
    'pipewire-jack'
    'alsa-lib'
    'jack2'
)
optdepends=(
    'nvidia-open: NVIDIA open kernel modules for RTX acceleration'
    'cuda: NVIDIA CUDA runtime for GPU acceleration'
    'nvidia-utils: NVIDIA driver utilities'
)
makedepends=(
    'rust'
    'cargo'
    'clang'
    'llvm'
    'pipewire'
    'jack2'
    'alsa-lib'
)
provides=('ghostwave')
conflicts=('ghostwave-git')
source=("$pkgname-$pkgver.tar.gz::https://github.com/ghostkellz/$pkgname/archive/v$pkgver.tar.gz")
sha256sums=('SKIP')

prepare() {
    cd "$pkgname-$pkgver"
    export RUSTUP_TOOLCHAIN=stable
    cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
    cd "$pkgname-$pkgver"
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target

    # Build with all audio backends
    cargo build --release --locked \
        --features "pipewire-backend,alsa-backend,jack-backend"
}

check() {
    cd "$pkgname-$pkgver"
    export RUSTUP_TOOLCHAIN=stable
    cargo test --release --locked
}

package() {
    cd "$pkgname-$pkgver"

    # Binary
    install -Dm755 "target/release/$pkgname" "$pkgdir/usr/bin/$pkgname"

    # Systemd user service
    install -Dm644 "systemd/ghostwave.user.service" \
        "$pkgdir/usr/lib/systemd/user/ghostwave.service"

    # Configuration
    install -Dm644 "config/default.toml" \
        "$pkgdir/usr/share/ghostwave/default.toml"

    # Documentation
    install -Dm644 "README.md" "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 "DOCS.md" "$pkgdir/usr/share/doc/$pkgname/DOCS.md"

    # License
    install -Dm644 "LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Shell completions
    install -dm755 "$pkgdir/usr/share/bash-completion/completions"
    install -dm755 "$pkgdir/usr/share/zsh/site-functions"
    install -dm755 "$pkgdir/usr/share/fish/vendor_completions.d"

    # Generate completions (if binary supports it)
    if "$pkgdir/usr/bin/$pkgname" --generate bash > /dev/null 2>&1; then
        "$pkgdir/usr/bin/$pkgname" --generate bash > \
            "$pkgdir/usr/share/bash-completion/completions/$pkgname"
        "$pkgdir/usr/bin/$pkgname" --generate zsh > \
            "$pkgdir/usr/share/zsh/site-functions/_$pkgname"
        "$pkgdir/usr/bin/$pkgname" --generate fish > \
            "$pkgdir/usr/share/fish/vendor_completions.d/$pkgname.fish"
    fi
}

# vim:set ts=4 sw=4 et:
